(function(a){function b(a,b,c){var d=a.val();a.empty();for(i=0;i<c.length;i++){var e,f;if(typeof c[i]=="object"){e=c[i][b.value];f=c[i][b.label]}else{e=f=c[i]}a.get(0).options[i]=new Option(f,e)}if(d&&a.find("option[value="+d+"]").length){a.val(d)}else{a.find("option:first").prop("selected",true)}a.prop("disabled",false).trigger("change")}a.fn.chainedSelect=function(c){var d=a.extend({},a.fn.chainedSelect.defaults,c);var e=d.cacheClass(d);return this.each(function(){var c=a(this);var f=a.metadata?a.extend({},d,c.metadata()):d;var g,h;if(f.preloadUrl){f.preloader=a("<img />").css({position:"absolute",border:"none",display:"none"}).attr("src",f.preloadUrl);c.after(f.preloader);g=function(){f.preloader.css({left:c.position().left+c.outerWidth()+5,top:c.position().top+c.outerHeight()/2-8}).show()};h=function(){f.preloader.hide()}}else{g=h=function(){}}if(!(f.parent instanceof a))f.parent=a(f.parent);f.parent.change(function(){var d=a(this).val();var i=a(this).attr("id")+"::"+d;c.prop("disabled",true);var j=e.getItem(i);if(j){b(c,f,j)}else{g();a.ajax({url:f.url,data:{q:d},type:f.type||"get",dataType:"json",global:false,success:function(a){b(c,f,a);h();e.setItem(i,a)},error:function(a,b,c){h();if(f.error)f.error(a,b,c)}})}});f.parent.trigger("change")})};a.fn.chainedSelect.Cache=function(a){var b={},c=[];return{getItem:function(a){if(a in b)return b[a];else return null},setItem:function(d,e){if(e){b[d]=e;var f=c.push(d);if(f>a.cacheLength){delete b[c.shift()]}}},clear:function(){b={};c=[]}}};a.fn.chainedSelect.defaults={value:"pk",label:"name",preloadUrl:"",cacheClass:a.fn.chainedSelect.Cache,cacheLength:10,error:null}})(jQuery)